# üöÇ Railway Deployment Guide - School Management System

This guide will walk you through deploying your full-stack school management dashboard to Railway.app.

## üìã Prerequisites

Before deploying, ensure you have:

- ‚úÖ A Railway account ([Sign up here](https://railway.app/))
- ‚úÖ GitHub account with your repository
- ‚úÖ Clerk account for authentication ([Get started](https://clerk.com/))
- ‚úÖ Cloudinary account for image uploads ([Get started](https://cloudinary.com/))
- ‚úÖ Pusher account for real-time messaging ([Get started](https://pusher.com/))
- ‚úÖ Gmail account with App Password (for email notifications)

---

## üöÄ Quick Start Deployment

### Step 1: Prepare Your Repository

1. **Push your code to GitHub** (if not already done):

   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git branch -M main
   git remote add origin https://github.com/YOUR_USERNAME/YOUR_REPO.git
   git push -u origin main
   ```

2. **Verify these files exist** (already created):
   - ‚úÖ `railway.json` - Railway configuration
   - ‚úÖ `Procfile` - Process configuration
   - ‚úÖ `.env.railway` - Environment variables template
   - ‚úÖ `src/app/api/health/route.ts` - Health check endpoint

### Step 2: Create Railway Project

1. Go to [Railway.app](https://railway.app/) and sign in
2. Click **"New Project"**
3. Select **"Deploy from GitHub repo"**
4. Choose your repository
5. Railway will detect it as a Next.js app

### Step 3: Add PostgreSQL Database

1. In your Railway project dashboard, click **"New"** ‚Üí **"Database"** ‚Üí **"Add PostgreSQL"**
2. Railway will automatically:
   - Create a PostgreSQL instance
   - Generate `DATABASE_URL` environment variable
   - Link it to your application

### Step 4: Configure Environment Variables

Click on your service ‚Üí **"Variables"** tab and add all required variables from `.env.railway`:

#### üîê **Required Variables**

```bash
# Database (Auto-generated by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# Clerk Authentication (Get from https://dashboard.clerk.com)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_...
CLERK_SECRET_KEY=sk_live_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/

# Cloudinary (Get from https://cloudinary.com/console)
NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME=your_cloud_name
NEXT_PUBLIC_CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret

# Pusher (Get from https://dashboard.pusher.com)
PUSHER_APP_ID=your_app_id
NEXT_PUBLIC_PUSHER_KEY=your_pusher_key
PUSHER_SECRET=your_pusher_secret
NEXT_PUBLIC_PUSHER_CLUSTER=your_cluster

# Cron Secret (Generate random token)
CRON_SECRET=your_secure_random_token_minimum_32_characters

# Node Environment
NODE_ENV=production
NEXT_TELEMETRY_DISABLED=1
```

#### üìß **Optional but Recommended**

```bash
# Gmail SMTP for email notifications
GMAIL_USER=your_email@gmail.com
GMAIL_APP_PASSWORD=your_16_character_app_password

# Web Push Notifications (Generate with: npx web-push generate-vapid-keys)
NEXT_PUBLIC_VAPID_PUBLIC_KEY=your_vapid_public_key
VAPID_PRIVATE_KEY=your_vapid_private_key
```

**üí° Tips for Environment Variables:**

- **CRON_SECRET**: Generate with `openssl rand -base64 32` or use any secure random string
- **Gmail App Password**: Enable 2FA on Gmail, then generate app password [here](https://myaccount.google.com/apppasswords)
- **VAPID Keys**: Run `npx web-push generate-vapid-keys` in terminal

### Step 5: Run Database Migrations

After deployment starts, you need to run migrations:

#### Option A: Using Railway CLI (Recommended)

1. Install Railway CLI:

   ```bash
   npm install -g @railway/cli
   ```

2. Login and link to your project:

   ```bash
   railway login
   railway link
   ```

3. Run migrations:

   ```bash
   railway run npm run railway:migrate
   ```

4. (Optional) Seed the database:
   ```bash
   railway run npm run railway:seed
   ```

#### Option B: Using Railway Dashboard

1. Go to your service ‚Üí **"Settings"** ‚Üí **"Deploy"**
2. Add a **"Deploy Command"**:
   ```bash
   npm run railway:migrate
   ```
3. This will run migrations on every deployment

### Step 6: Configure Custom Domain (Optional)

1. In Railway dashboard, go to **"Settings"** ‚Üí **"Networking"**
2. Click **"Generate Domain"** for a free Railway subdomain
3. Or add your custom domain:
   - Click **"Custom Domain"**
   - Follow DNS configuration instructions

### Step 7: Update Clerk Redirect URLs

1. Go to [Clerk Dashboard](https://dashboard.clerk.com)
2. Navigate to your application
3. Go to **"Paths"** or **"Session & Authentication"**
4. Add your Railway URLs:
   - **Sign-in URL**: `https://your-app.up.railway.app/`
   - **Sign-up URL**: `https://your-app.up.railway.app/`
   - **Redirect URLs**:
     - `https://your-app.up.railway.app/*`
     - `https://your-app.up.railway.app/admin`
     - `https://your-app.up.railway.app/teacher`
     - `https://your-app.up.railway.app/student`
     - `https://your-app.up.railway.app/parent`

### Step 8: Verify Deployment

1. Wait for deployment to complete (usually 3-5 minutes)
2. Visit your Railway app URL
3. Test the health endpoint: `https://your-app.up.railway.app/api/health`
   - Should return: `{"status":"healthy","database":"connected"}`

---

## üîß Post-Deployment Setup

### Create Your First Admin User

Since Clerk handles authentication, you need to create users through Clerk dashboard:

1. Go to [Clerk Dashboard](https://dashboard.clerk.com) ‚Üí Your App ‚Üí **"Users"**
2. Click **"Create User"**
3. Fill in user details
4. **Important**: In **"Public Metadata"**, add:
   ```json
   {
   	"role": "admin"
   }
   ```
5. This user can now access the admin panel

### Set Up Cron Jobs (For Background Tasks)

Your app has several cron jobs that need to be triggered:

#### üéØ Available Cron Endpoints:

1. **Badge Processing**: `/api/cron/process-badges`

   - Awards badges to students based on leaderboard
   - Recommended: Daily at midnight

2. **Teacher Leaderboard Update**: `/api/cron/update-teacher-leaderboard`

   - Updates teacher ratings and rankings
   - Recommended: Every 6 hours

3. **Auto-Absent Teachers**: `/api/cron/mark-absent-teachers`

   - Marks teachers absent if they don't check in
   - Recommended: Daily at 9 AM

4. **Expire Suspensions**: `/api/cron/expire-suspensions`
   - Expires student cheating suspensions
   - Recommended: Hourly

#### üöÄ Setup with Railway Cron Jobs (Paid Feature)

If you have Railway Pro:

1. Go to your service ‚Üí **"Cron Jobs"**
2. Add schedules:
   ```
   0 0 * * * /api/cron/process-badges
   0 */6 * * * /api/cron/update-teacher-leaderboard
   0 9 * * * /api/cron/mark-absent-teachers
   0 * * * * /api/cron/expire-suspensions
   ```

#### üÜì Alternative: Use External Cron Service (Free)

Use [Cron-job.org](https://cron-job.org) or [EasyCron](https://easycron.com):

1. Create account and add cron jobs
2. Configure URLs with Authorization header:
   - URL: `https://your-app.up.railway.app/api/cron/process-badges`
   - Header: `Authorization: Bearer YOUR_CRON_SECRET`
3. Set schedules as described above

---

## üêõ Troubleshooting

### Build Fails

**Error**: `Prisma Client not generated`

- **Solution**: Railway should automatically run `postinstall` script. Check build logs.

**Error**: `Module not found`

- **Solution**: Clear build cache in Railway ‚Üí Settings ‚Üí Reset Build Cache

### Database Connection Issues

**Error**: `Can't reach database server`

- **Solution**:
  1. Verify `DATABASE_URL` is set correctly
  2. Check PostgreSQL service is running
  3. Ensure both services are in the same project

### Image Uploads Not Working

**Error**: Images not uploading to Cloudinary

- **Solution**:
  1. Verify Cloudinary credentials are correct
  2. Check upload preset "school" exists in Cloudinary
  3. Verify domain is added to allowed origins in Cloudinary settings

### Real-time Messaging Not Working

**Error**: Messages not appearing in real-time

- **Solution**:
  1. Verify Pusher credentials are correct
  2. Check Pusher app cluster matches
  3. Enable CORS in Pusher dashboard for your Railway domain

### Authentication Issues

**Error**: Redirecting to login after sign in

- **Solution**:
  1. Update Clerk redirect URLs with Railway domain
  2. Verify `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` is correct
  3. Check user has proper `role` in `publicMetadata`

### Health Check Failing

**Error**: `/api/health` returns 503

- **Solution**:
  1. Check database connection
  2. Run migrations: `railway run npm run railway:migrate`
  3. Check logs for database errors

---

## üìä Monitoring & Logs

### View Application Logs

1. Railway Dashboard ‚Üí Your Service ‚Üí **"Logs"**
2. Filter by level: `error`, `warn`, `info`
3. Real-time log streaming

### Monitor Database

1. Railway Dashboard ‚Üí PostgreSQL service ‚Üí **"Metrics"**
2. View:
   - Connection count
   - CPU & Memory usage
   - Query performance

### Performance Monitoring

Railway automatically tracks:

- ‚úÖ Request latency
- ‚úÖ Error rates
- ‚úÖ Resource usage

---

## üîÑ Continuous Deployment

Railway automatically deploys when you push to GitHub:

```bash
git add .
git commit -m "Update feature"
git push origin main
```

Railway will:

1. Detect the push
2. Build the application
3. Run migrations (if configured)
4. Deploy automatically

---

## üí∞ Cost Estimate

### Railway Pricing (as of 2025):

- **Hobby Plan** ($5/month):
  - $5 credit included
  - Pay for usage beyond credit
  - PostgreSQL database included
  - Custom domains
- **Pro Plan** ($20/month):
  - $20 credit included
  - Priority builds
  - Advanced metrics
  - Cron jobs

**Estimated Monthly Cost for This App**:

- Small usage: ~$5-10/month (Hobby plan)
- Medium usage: ~$15-25/month
- High usage: ~$30-50/month

---

## üéì Additional Services Setup

### Cloudinary Configuration

1. Go to [Cloudinary Console](https://cloudinary.com/console)
2. Create an **upload preset** named "school":
   - Settings ‚Üí Upload ‚Üí Upload Presets ‚Üí Add Upload Preset
   - Preset Name: `school`
   - Signing Mode: `Unsigned`
   - Folder: `school-management`

### Pusher Configuration

1. Go to [Pusher Dashboard](https://dashboard.pusher.com)
2. Create a **Channels** app
3. Enable **Client Events** in App Settings
4. Add your Railway domain to **Allowed Origins**

### Gmail SMTP Setup

1. Enable 2-Factor Authentication on your Gmail account
2. Go to [App Passwords](https://myaccount.google.com/apppasswords)
3. Generate a new app password for "Mail"
4. Use this 16-character password as `GMAIL_APP_PASSWORD`

---

## üì± Testing Your Deployment

### Checklist:

- [ ] Health check returns `healthy`: `/api/health`
- [ ] Can access login page: `/`
- [ ] Can create and login as admin
- [ ] Dashboard loads correctly: `/admin`, `/teacher`, `/student`, `/parent`
- [ ] Can create students, teachers, classes
- [ ] Image upload works (try adding student photo)
- [ ] Real-time messaging works (send a message)
- [ ] Email notifications work (test with payment approval)
- [ ] Cron jobs execute (check badge awards)

---

## üÜò Support & Resources

- **Railway Docs**: https://docs.railway.app
- **Next.js Docs**: https://nextjs.org/docs
- **Prisma Docs**: https://www.prisma.io/docs
- **Clerk Docs**: https://clerk.com/docs

---

## üéâ Deployment Complete!

Your School Management System is now live on Railway!

**What's Next?**

1. ‚úÖ Set up cron jobs for automated tasks
2. ‚úÖ Create admin users via Clerk
3. ‚úÖ Test all features thoroughly
4. ‚úÖ Configure backups (Railway Pro feature)
5. ‚úÖ Set up monitoring alerts
6. ‚úÖ Add custom domain
7. ‚úÖ Optimize performance based on metrics

---

**Need Help?** Check the troubleshooting section or Railway's support documentation.

**Pro Tip**: Always test in a staging environment before deploying major changes to production!
